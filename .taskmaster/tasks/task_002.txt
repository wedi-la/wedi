# Task ID: 2
# Title: Design Core Database Schema
# Status: in-progress
# Dependencies: 1
# Priority: high
# Description: Define the core database schema for multi-tenancy, payment processing, and Thirdweb authentication using Prisma ORM.
# Details:
Use Prisma ORM to define the schema for core entities such as Organization, User, PaymentLink, PaymentOrder, ProviderTransaction, AuditLog, Wallet, Agent, Customer, Product, and Price. Implement multi-tenant data model with Organization-based data isolation. Configure Prisma to work with Neon DB (serverless PostgreSQL). Support Thirdweb authentication by storing user wallet addresses, linking web2 identities to blockchain wallets, and tracking wallet types. Set up the Prisma client and migrations. Ensure the packages structure includes packages/prisma for schema and client configuration, packages/ui for shared React components with Shadcn UI, and packages/types for shared TypeScript types. Integrate Agents as the primary execution layer, linking PaymentLink to Agent (executingAgentId) and Agent to Wallet (agentWalletId).

# Test Strategy:
Run Prisma migrations and verify schema correctness. Test multi-tenancy by creating multiple organizations and ensuring data isolation. Verify Thirdweb authentication support by testing wallet address storage and linkage with web2 identities. Ensure the workspace configuration supports the proper structure. Test the integration of Agents with PaymentLink and Wallet, and validate the new Customer, Product, and Price entities.

# Subtasks:
## 1. Review Prisma Schema and Data Model Specifications [done]
### Dependencies: None
### Description: Analyze the existing Prisma schema and the comprehensive data model specifications to understand the structure and relationships of the data.
### Details:
Examine the 'docs/data-models-specification.md' document and the Prisma schema to identify all models, fields, and relationships.
<info added on 2025-06-08T01:05:52.363Z>
Include multi-tenancy implementation details, provider abstraction layer, and Web3/blockchain models in the conversion process.
</info added on 2025-06-08T01:05:52.363Z>

## 2. Convert Prisma Models to SQLAlchemy ORM Models [done]
### Dependencies: 2.1
### Description: Translate the Prisma models into SQLAlchemy ORM models, ensuring all fields and data types are accurately represented.
### Details:
For each model in the Prisma schema, create a corresponding SQLAlchemy model class with appropriate fields and data types.
<info added on 2025-06-08T01:24:07.263Z>
The project architecture specifies the use of Prisma ORM instead of SQLAlchemy. Ensure the Prisma schema is correctly set up in the packages/prisma directory and integrate the Prisma client with the existing api app. Verify that the turborepo structure includes the necessary packages: prisma, ui, and types. Use Bun as the package manager for consistency with the architectural guidelines.
</info added on 2025-06-08T01:24:07.263Z>
<info added on 2025-06-08T01:32:02.699Z>
Create SQLAlchemy models in apps/api/app/models/ that match the Prisma schema structure to ensure the FastAPI backend can interact with the same database schema.
</info added on 2025-06-08T01:32:02.699Z>

## 11. Set Up Prisma Schema and Client [done]
### Dependencies: 2.1
### Description: Configure the Prisma schema and set up the Prisma client for database interactions.
### Details:
Define the Prisma schema in packages/prisma/schema.prisma. Set up the Prisma client to interact with Neon DB and integrate it with the FastAPI backend.

## 12. Implement Multi-Tenancy with Organization-Based Data Isolation [pending]
### Dependencies: 2.11
### Description: Set up multi-tenancy by implementing organization-based data isolation using Prisma.
### Details:
Add an 'organization_id' field to relevant models and configure Prisma to filter queries based on the current user's organization context. Ensure the FastAPI backend supports multi-tenancy by implementing necessary middleware or context management.

## 13. Configure Prisma with Neon DB [done]
### Dependencies: 2.11
### Description: Set up Prisma to work with Neon DB (serverless PostgreSQL) for database operations.
### Details:
Ensure the Prisma configuration is compatible with Neon DB, including connection settings and any necessary environment variables. Verify the connection by running test queries.

## 14. Create Prisma Migrations [done]
### Dependencies: 2.11
### Description: Develop migration scripts using Prisma to manage database schema changes.
### Details:
Use Prisma's migration capabilities to create and apply migration scripts that reflect the current schema. Ensure migrations are tested and applied in the development environment.

## 15. Complete Remaining SQLAlchemy Models [pending]
### Dependencies: 2.2
### Description: Develop the remaining SQLAlchemy models to match the Prisma schema.
### Details:
Create SQLAlchemy models for PaymentLink, PaymentOrder, ProviderTransaction, AuditLog, and Wallet in apps/api/app/models/ to ensure full compatibility with the Prisma schema.

## 16. Integrate Agent Model with PaymentLink and Wallet [done]
### Dependencies: 2.11
### Description: Enhance the Agent model to reflect its execution role and integrate it with PaymentLink and Wallet.
### Details:
Add executingAgentId to PaymentLink and agentWalletId to Agent. Ensure the Agent model reflects its role in executing orders and managing smart wallets.

## 17. Add Customer, Product, and Price Entities [done]
### Dependencies: 2.11
### Description: Introduce new entities for Customer, Product, and Price to support end-customer management and flexible pricing.
### Details:
Define Customer, Product, and Price models in the Prisma schema. Ensure these entities are linked to the Organization for multi-tenancy support.

